# Хранилище

Позволяет сохранять и загружать любые данные на сервера Balancy. Обязательно авторизуйте игрока (хотя бы как гостя) перед использованием, т. к. все записи связаны с определёнными игроками.

## Основная информация

#### Коллекции и ключи
У каждого игрока может быть набор коллекций, каждая из которых имеет несколько ключей. При сохранении в Хранилище необходимо указать как коллекцию, так и ключ. Однако для загрузки данных есть два варианта:

1. Загрузить определённый ключ из определённой коллекции.
2. Загрузить всю коллекцию.

Вы можете думать о коллекции как о книге, где ключ — это глава книги. У вас может быть сколько угодно книг с множеством разных глав в каждой. И вам решать, что вы хотите написать в каждой главе.

И коллекция, и ключ являются строковыми значениями. Просто убедитесь, что вы загружаете из той же пары коллекция-ключ, которую вы использовали при отправке сохранений.

###### Пример
У вас может быть коллекция «Игрок» со ключами: «Инвентарь», «Заклинания», «Статистика» и т. д. При изменении данных вам нужно обновить только небольшую часть, которая будет храниться под одним ключом. Но когда вы запускаете игру, вы можете загрузить весь профиль со всеми ключами.

#### Версии
Ещё одна важная особенность — **версии**. Balancy обрабатывает их автоматически, но лучше понять, как этот механизм работает под капотом.
Каждая запись в базе данных имеет свою версию, которая увеличивается при каждом изменении данных. Механизм необходим для предотвращения использования устаревших данных.

###### Пример 
Вы запускаете игру на **Устройстве 1**, играете некоторое время, и последняя версия вашего прогресса, скажем, будет **5**. Затем вы переключаетесь на **Устройство 2**, которое загружает прогресс с версией **5**, отправляете какие-то изменения на сервер, после чего версия поднимется до **6**. Наконец, вы повторно открываете игру на **Устройстве 1**, где у клиента всё ещё есть версия **5**. В следующий раз, когда этот клиент попытается отправить изменения на сервер, он получит ошибку, связанную с версией данных.

Решить эту проблему можно двумя способами:

1. Игнорировать версию (передав параметр в метод `Save`). Не рекомендуется, т. к. могут быть затёрты важные изменения.
2. Если вы получили такую ошибку, перезагрузите игровой прогресс, чтобы получить последние данные и актуальную версию данных, а затем примените их к своей игре.

#### Типы данных

Поддерживаются 2 варианта:

1. Простая строка **string**.
2. Любой класс. 

Мы используем конвертер Newtonsoft для сериализации и десериализации объектов. Ниже пример класса, который мы можем использовать для сохранения/загрузки данных:

```csharp fct_label="Unity"
private class SaveExample
{
    public int IntValue;
    public string StringValue;

    [JsonIgnore]
    public int IgnoredValue;
    
    [JsonIgnore]
    public int AlsoIgnoredValue { get { return IntValue; } }
}   
```

В приведённом выше примере **IntValue** и **StringValue** будут сохранены и загружены, тогда как другие 2 поля — нет. Если вы не хотите, чтобы какие-либо свойства или атрибуты синхронизировались с сервером, просто пометьте их аттрибутом [JsonIgnore].

### Сохранение

Пример с сохранением строки:

```csharp fct_label="Unity"
Balancy.Storage.Save("MyCollection1", "StringKey", "Hello World!", saveResponse =>
{
    Debug.Log("String was saved result: " + saveResponse.Success);
});
```

При с сохранением объекта:

```csharp fct_label="Unity"
var saveExample = new SaveExample
{
    IntValue = 5,
    StringValue = "Hello World",
    IgnoredValue = 3
};

Balancy.Storage.Save("MyCollection2", "ObjectKey", saveExample, saveResponse =>
{
    Debug.Log("Object was saved result: " + saveResponse.Success);
});
```

### Загрузка

Пример загрузки сохранённой ранее строки:

```csharp fct_label="Unity"
Balancy.Storage.Load<string>("MyCollection1", "StringKey", loadResponse =>
{
    Debug.Log("String was loaded result: " + loadResponse.Success);
    if (loadResponse.Success)
        Debug.Log("Value = " + loadResponse.Data.Value);
});
```

Пример загрузки сохранённого ранее объекта:

```csharp fct_label="Unity"
Balancy.Storage.Load<SaveExample>("MyCollection2", "ObjectKey", loadResponse =>
{
    Debug.Log("Object was loaded result: " + loadResponse.Success);
    if (loadResponse.Success)
    {
        SaveExample saveExample = loadResponse.Data.Value;
        Debug.Log("String Value = " + saveExample.StringValue);
    }
});
```

### Лимиты

1. Вы можете сохранять/загружать одну и ту же комбинацию коллекция-ключ не чаще одного раза в 20 секунд.
2. Максимальный размер сохраняемых данных 100 КБ.

Эти ограничения в будущем могут измениться.
