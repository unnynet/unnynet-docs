# Схема данных

При [публикации](/data_editor/deploy/) генерируются Json'ы и отправляются на CDN. Для каждого шаблона создаётся отдельный файл с припиской версии и префиксом окружения.

Текущие актуальные версии всех шаблонов можно посмотреть в отдельном файле версий, путь до которого выглядит так:

    https://data.un-cdn.unnyplay.com/entities/{game_id}/{environment}/versions.json
   
Где:

| Параметр          | Описание
| :---------------: | :----------------------------------------------------------------------------- |
|**{game_id}**      | guid игры; можно скопировать на странице со списком игр или из адресной строки |
|**{environment}**  | Окружение: dev, stage, production                                              |

К примеру, если вы опубликовали изменения в dev окружении, а guid игры `11111111-1111-1111-111111111111`, то ссылка будет иметь вид:

    https://data.un-cdn.unnyplay.com/entities/11111111-1111-1111-111111111111/dev/versions.json

##Структура файла версий:

    {
        "dictionaries": [
            {
                "version": "3",
                "name": "EnemyInfo",
                "id": "10587"
            },
            {
                "version": "5",
                "name": "DamageInfo",
                "id": "12"
            }
        ]
    }

Под ключом `dictionaries` список шаблонов с информацией о них.

Где:

Параметр         | Описание
:---------------:|:-----
**version**      | текущая версия шаблона; повышается, если на момент публикации были какие-то изменения в шаблоне или документах этого шаблона
**name**         | **Name** шаблона из админки
**id**           | Служебный идентификатор шаблона. Уникальный. Не меняется со временем.

Теперь, чтобы получить сами данные по шаблону из примера, нужно скачать файл по адресу:

    https://data.un-cdn.unnyplay.com/entities/11111111-1111-1111-111111111111/dev/EnemyInfo_v3.json

##Структура файлов с данными шаблонов

    {
        "list": []
    }

Под ключом `list` все документы этого шаблона. Объекты в массиве содержат значения параметров по их имени, плюс некоторые служебные параметры. Как пример:

    {
        "list": [
            {
                "unnyId": "3398",
                "unnyIdDamageInfoOfEnemy": "122",
                "probabilityInt": 1,
                "probabilityFloat": 1.2,
                "stringParam": "test",
                "count": {
                    "unnyId": "3399",
                    "min": 1,
                    "max": 1
                },
                "limitedBool": true,
                "myEnum": 1
            }
        ]
    }

1. У каждого объекта (в том числе и вложенного) есть параметр `unnyId`. Это уникальный Id документа в Balancy. Не меняется со временем.
2. Примитивы записываются как **Name** (в camelCase) и значение с приведением типа.
3. В значениях enum'ов числовое значение.
4. С параметрами типа **Document** или **List of Documents** чуть сложнее. Ключ параметра формируется как **unnyId** + **Name** параметра. Если у параметра имя **DamageInfoOfEnemy**, то в Json'е будет имя **unnyIdDamageInfoOfEnemy**. По значению этого параметра можно найти конкретный документ из файла документов того шаблона, тип которого задан для этого параметра. В нашем примере это шаблон **DamageInfo**, у которого текущая версия `5`, значит в списке документов в файле `https://data.un-cdn.unnyplay.com/entities/11111111-1111-1111-111111111111/dev/DamageInfo_v5.json` нужно найти документ с параметром `unnyId` равным `122`.
5. Для параметров типа Component всё аналогично параметрам типа Document (см. п. 4).
6. Параметры с типом **Injected Component** встраиваются в родительский документ. Для них имя формируется просто **Name** (в camelCase) как и для примитивов, но в значение записывается целиком сам документ. В нашем примере это параметр **Count**. Для таких вложенных параметров применяются все вышеописанные правила.

### Кодогенератор
Следует изучить код, генерируемый нашей системой чтобы лучше понять как все работает и почему.

1. При запуске скачивается файл версий.
2. Файл версий сравнивается с закешированной версией.
3. Если версия какого нибудь шаблона была изменена, то плагин скачивает обновленную версию и кеширует ее.
4. Все JSON файлы шаблонов считываются, все документы мапятся на свои классы и добавляются в Общий словарь по ключу `unnyId`.
5. Все ссылки резолвятся из Общего словаря при запросе. 
